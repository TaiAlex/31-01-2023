import glob
import os.path
import pydub
import speech_recognition as sr
import pyaudio
from pydub.utils import which

pydub.AudioSegment.converter = which("ffmpeg")

def split_list_answer(text_path):
    col_answer = []
    with open(text_path,"r", encoding="UTF-8") as f:
        ot = f.read()       #original text
    for j in ot.split('bắt đầu'):
        answer = j.split('thời')[0].strip()[-1]
        col_answer.append(answer.upper())
    col_answer.pop(0)
    return col_answer

def find_path():
    folder_path = r'/home/ubuntu/html_1/upload/*'
    sub_folders = glob.glob(folder_path)
    the_lastest_subfolder = max(sub_folders, key=os.path.getctime)
    files = glob.glob(the_lastest_subfolder + '/*')
    the_last_file = max(files, key=os.path.getctime)
    print(the_last_file)
    return the_last_file

def mp3_to_wav(file_path):
    type = file_path.split('.')[1]
    if type == 'mp3':
        mp3_path = str(file_path)
        wav_path = str(file_path.split('.')[0] + '.wav')
        sound = pydub.AudioSegment.from_mp3(mp3_path)
        sound.export(wav_path, format="wav")
        print(wav_path)
        return wav_path
    elif type == 'wav':
        return file_path
    else:
        return False
            
def wav_to_txt(wav):
    text_path = wav.split('.')[0] + '.txt'
    print(text_path)
    r = sr.Recognizer()
    with sr.AudioFile(wav) as source:
        audio = r.record(source)
        text = r.recognize_google(audio, language = "vi-VI")
        with open(text_path, mode = 'a', encoding = 'UTF-8', errors = 'ignore') as data:
            data.write(str(text))
        return text_path
